<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  metal:use-macro="context/@@groupserver_site_home_layout/page">
  <head>
    <title metal:fill-slot="title">
      <span tal:replace="view/siteInfo/name"/>: Login
    </title>
  </head>
  <body>
    <div metal:fill-slot="utilitylinks" 
      id="utilitylinks">&#160;</div><!--utilitylinks-->
    <div metal:fill-slot="messages" id="form-message"
      class="ui-widget ui-state-error ui-corner-all;"
      tal:define="state view/processCredentials;"
      tal:condition="python:view.state and not view.state[0]">
      <div class="message-error">
        <p>Please enter your email address and password below.</p>
        <p>This is usually neccessary for one of these reasons:</p>
        <ul>
          <li>you attempted to login, but either your email address or
            your password was incorrect</li>
          
          <li>you tried to access a link inside the restricted area,
            but you haven't yet logged in (this could have happened if
            you clicked on a link in an email, for instance)</li>
          
          <li>your browser does not have cookies enabled</li>
        </ul>
      </div><!--message-error-->
    </div><!--form-message-->
    <tal:block metal:fill-slot="body">
      <div id="gs-login-anon" 
        tal:condition="view/loggedInUserInfo/anonymous">
        <h1>Login</h1>
        <form id="login-form" tal:attributes="action request/URL">
          <input type="hidden" id="seed" name="seed" 
            tal:attributes="value view/encryptionSeed"/>
          <input type="hidden" id="ep" name="ep" 
            tal:attributes="value view/passwordsEncrypted"/>
          <input type="hidden" id="ph" name="ph" value=""/>
          <input type="hidden" id="came_from" name="came_from"
            tal:attributes="value request/came_from | nothing" />
          <input type="hidden" id="failed" name="failed" 
            tal:define="v python:view.state and not view.state[0]"
            tal:attributes="value v"/>
          <div id="login"
            class="form-widget required">
            <label class="text" 
              title="Enter the email address, or login name, you use with your forums on this site"
              for="login">Email Address</label>
            <input id="login"  name="login" class="textType" type="text" 
              value="" title="Enter your email address here" />
          </div><!--login-->
          <div id="gs-login-password" 
            class="form-widget required">
            <label class="textType"
              title="Enter the password that you use with this site (case-sensitive)"
              for="password">Password</label>
            <input id="password" class="textType"
              type="password" name="password" 
              value="" title="Enter your password"/>
          </div><!--gs-login-password-->
          <div id="gs-login-remember-me"
            class="form-widget not-required">
            <input type="checkbox" title="Remember me" 
              class="checkboxType" value="1" 
              name="__ac_persistent" id="__ac_persistent" />
            <label for="__ac_persistent" class="checkboxLabel"
              title="Check this if you want to automatically log in next time you visit this site from this computer. Do not check this if you are using a public terminal!">Remember me</label>
          </div><!--gs-login-remember-me-->

          <div id="gs-login-buttons" class="buttons">
            <div class="formelementbutton">
              <input class="button" type="submit" name="submit" 
                id="loginButton" value="Login" />
            </div>
          </div><!--gs-login-buttons-->
        </form><!--login-form-->
        <dl>
          <dt>Can't log in?</dt>
          <dd>
            <a href="/reset_password.html">Reset your 
              <strong>password</strong></a>
          </dd>
          <dt>Help</dt>
          <dd>
            Check the
            <a href="/help/faqs"><strong>frequently asked
              questions</strong></a>
          </dd>
        </dl>
      </div><!--gs-login-anon-->
      <tal:block condition="not:view/loggedInUserInfo/anonymous">
        <div id="gs-login-done"
          tal:condition="view/logged_in_user_viewing_login">
          <h1>You are Already Logged In</h1>
          <p>
            You cannot login, because you are already logged in!
            Go to 
            <a href="/">the homepage for
              <span class="site" 
                tal:content="view/siteInfo/get_name">this site</span></a>
            to view the messages in your groups.</p>
        </div><!--gs-login-done-->
        <div id="gs-login-permission-denied"
          tal:condition="not:view/logged_in_user_viewing_login">
          <h1>Permission Denied</h1>
          <p>
            You do not have permission to see the page
            <code tal:content="python:request.form.get('came_from', '')"
              class="url">#</code>.
            <a tal:attributes="href view/supportMessage" 
              class="email" href="#">Email support</a>
            if you think you should have permission to view this page,
            and we will try and help you.
          </p>
        </div><!--gs-login-permission-denied-->
      </tal:block><!--not:view/loggedInUserInfo/anonymous-->
    </tal:block><!--body-->
    <tal:block metal:fill-slot="javascript">
      <script type="text/javascript" 
        src="/++resource++crypto/sha1.js">&#160;</script>
      <script type="text/javascript"
        src="/++resource++popup_help-20071218.js">&#160;</script>
      <script type="text/javascript"
        tal:condition="view/loggedInUserInfo/anonymous">
        jQuery.noConflict();
        function loginSubmit(event) {
            var el = jQuery('#login-form');
            var pw = jQuery('#password').val();
            var encrypt = jQuery('#ep').val();
            if (encrypt == 'True') {
                pw = b64_sha1(pw);
            }
            var loginText = jQuery('#login').val();
            var seed = jQuery('#seed').val();
            var new_passvalue = hex_hmac_sha1(pw, (loginText+pw+seed));
            jQuery('#ph').val(new_passvalue);
            jQuery('#password').val('');
            //Event.unloadCache();
        };
        function setupLogin(event) {
            jQuery('#login-form').submit(loginSubmit);
        }
        jQuery(document).ready(setupLogin);
        jQuery.noConflict()
        jQuery(document).ready( function () {
            GSPopupFormHelp.init('#login-form');
        });
        jQuery('#login').focus();
      </script>
    </tal:block>
  </body>
</html>

